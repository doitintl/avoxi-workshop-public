{"version":3,"sources":["../src/embedder.ts"],"sourcesContent":["/**\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  defineEmbedder,\n  embedderRef,\n  EmbedderReference,\n} from '@genkit-ai/ai/embedder';\nimport { GoogleAuth } from 'google-auth-library';\nimport { z } from 'zod';\nimport { PluginOptions } from './index.js';\nimport { PredictClient, predictModel } from './predict.js';\n\nexport const TaskTypeSchema = z.enum([\n  'RETRIEVAL_DOCUMENT',\n  'RETRIEVAL_QUERY',\n  'SEMANTIC_SIMILARITY',\n  'CLASSIFICATION',\n  'CLUSTERING',\n]);\nexport type TaskType = z.infer<typeof TaskTypeSchema>;\n\nexport const TextEmbeddingGeckoConfigSchema = z.object({\n  /**\n   * The `task_type` parameter is defined as the intended downstream application to help the model\n   * produce better quality embeddings.\n   **/\n  taskType: TaskTypeSchema.optional(),\n  title: z.string().optional(),\n  location: z.string().optional(),\n});\nexport type TextEmbeddingGeckoConfig = z.infer<\n  typeof TextEmbeddingGeckoConfigSchema\n>;\n\nexport const textEmbeddingGecko003 = embedderRef({\n  name: 'vertexai/textembedding-gecko@003',\n  configSchema: TextEmbeddingGeckoConfigSchema,\n  info: {\n    dimensions: 768,\n    label: 'Vertex AI - Text Embedding Gecko',\n    supports: {\n      input: ['text'],\n    },\n  },\n});\n\nexport const textEmbeddingGecko002 = embedderRef({\n  name: 'vertexai/textembedding-gecko@002',\n  configSchema: TextEmbeddingGeckoConfigSchema,\n  info: {\n    dimensions: 768,\n    label: 'Vertex AI - Text Embedding Gecko',\n    supports: {\n      input: ['text'],\n    },\n  },\n});\n\nexport const textEmbeddingGecko001 = embedderRef({\n  name: 'vertexai/textembedding-gecko@001',\n  configSchema: TextEmbeddingGeckoConfigSchema,\n  info: {\n    dimensions: 768,\n    label: 'Vertex AI - Text Embedding Gecko (Legacy)',\n    supports: {\n      input: ['text'],\n    },\n  },\n});\n\nexport const textEmbedding004 = embedderRef({\n  name: 'vertexai/text-embedding-004',\n  configSchema: TextEmbeddingGeckoConfigSchema,\n  info: {\n    dimensions: 768,\n    label: 'Vertex AI - Text Embedding 004',\n    supports: {\n      input: ['text'],\n    },\n  },\n});\n\nexport const textMultilingualEmbedding002 = embedderRef({\n  name: 'vertexai/text-multilingual-embedding-002',\n  configSchema: TextEmbeddingGeckoConfigSchema,\n  info: {\n    dimensions: 768,\n    label: 'Vertex AI - Text Multilingual Embedding 002',\n    supports: {\n      input: ['text'],\n    },\n  },\n});\n\nexport const textEmbeddingGeckoMultilingual001 = embedderRef({\n  name: 'vertexai/textembedding-gecko-multilingual@001',\n  configSchema: TextEmbeddingGeckoConfigSchema,\n  info: {\n    dimensions: 768,\n    label: 'Vertex AI - Multilingual Text Embedding Gecko 001',\n    supports: {\n      input: ['text'],\n    },\n  },\n});\n\nexport const textEmbeddingGecko = textEmbeddingGecko003;\n\nexport const SUPPORTED_EMBEDDER_MODELS: Record<string, EmbedderReference> = {\n  'textembedding-gecko@003': textEmbeddingGecko003,\n  'textembedding-gecko@002': textEmbeddingGecko002,\n  'textembedding-gecko@001': textEmbeddingGecko001,\n  'text-embedding-004': textEmbedding004,\n  'textembedding-gecko-multilingual@001': textEmbeddingGeckoMultilingual001,\n  'text-multilingual-embedding-002': textMultilingualEmbedding002,\n};\n\ninterface EmbeddingInstance {\n  task_type?: TaskType;\n  content: string;\n  title?: string;\n}\ninterface EmbeddingPrediction {\n  embeddings: {\n    statistics: {\n      truncated: boolean;\n      token_count: number;\n    };\n    values: number[];\n  };\n}\n\nexport function textEmbeddingGeckoEmbedder(\n  name: string,\n  client: GoogleAuth,\n  options: PluginOptions\n) {\n  const embedder = SUPPORTED_EMBEDDER_MODELS[name];\n  const predictClients: Record<\n    string,\n    PredictClient<EmbeddingInstance, EmbeddingPrediction>\n  > = {};\n  const predictClientFactory = (\n    config: TextEmbeddingGeckoConfig\n  ): PredictClient<EmbeddingInstance, EmbeddingPrediction> => {\n    const requestLocation = config?.location || options.location;\n    if (!predictClients[requestLocation]) {\n      // TODO: Figure out how to allow different versions while still sharing a single implementation.\n      predictClients[requestLocation] = predictModel<\n        EmbeddingInstance,\n        EmbeddingPrediction\n      >(\n        client,\n        {\n          ...options,\n          location: requestLocation,\n        },\n        name\n      );\n    }\n    return predictClients[requestLocation];\n  };\n\n  return defineEmbedder(\n    {\n      name: embedder.name,\n      configSchema: embedder.configSchema,\n      info: embedder.info!,\n    },\n    async (input, options) => {\n      const predictClient = predictClientFactory(options);\n      const response = await predictClient(\n        input.map((i) => {\n          return {\n            content: i.text(),\n            task_type: options?.taskType,\n            title: options?.title,\n          };\n        })\n      );\n      return {\n        embeddings: response.predictions.map((p) => ({\n          embedding: p.embeddings.values,\n        })),\n      };\n    }\n  );\n}\n"],"mappings":"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","names":["options"]}